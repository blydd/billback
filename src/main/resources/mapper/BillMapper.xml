<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.billback.mapper.BillMapper">

    <select id="getBills" resultType="com.example.billback.vo.BillVo">
        SELECT
            b.*
        FROM
            bills b
            LEFT JOIN bill_tags bt ON bt.bill_id = b.id
            LEFT JOIN tags t ON bt.tag_id = t.id
        <where>
            1 = 1
            <!-- 用户 -->
            <if test="billDto.userId != null">
                AND b.user_id = #{billDto.userId}
            </if>
            <!-- 收支类型:1-支出,2收入,3不计入收支 -->
            <if test="billDto.inoutType != null">
                AND b.inout_type = #{billDto.inoutType}
            </if>
            <!-- 账单月份 -->
            <if test="billDto.month != null and billDto.month != ''">
                AND DATE_FORMAT(b.bill_date, '%Y-%m') = #{billDto.month}
            </if>
            <!-- 标签取交集 -->
            <if test="billDto.tagIds != null and billDto.tagIds.size > 0 ">
                and b.id in
                <foreach collection="billDto.tagIds" item="t" separator="INTERSECT" index="i" open="(" close=")">
                    SELECT bill_id from bill_tags WHERE tag_id = #{t}
                </foreach>
            </if>
            <!-- 账户类型:1储蓄账户,2信用账户 -->
            <if test="billDto.accountType != null">
                and t.account_type = #{billDto.accountType}
            </if>
        </where>
        GROUP BY b.id
    </select>

</mapper>